# Shot Keyframe Structured Prompt Design

## Overview
Restructure the shot production workflow to eliminate the "middleman" prompt generation step and assemble image generation prompts directly from rich storyboard artifacts. This change improves fidelity by using the original shot direction metadata without lossy transformation into string prompts.

## Core Design Principles
1. **Storyboard as Source of Truth**: The `storyboard_entry` produced by Gemini's shot director should contain all information needed for image/video generation without intermediate transformations.
2. **Direct Assembly Over Generation**: Image generation prompts should be mechanically assembled from storyboard data, visual design, and audio design documents rather than generated by the AI.
3. **Explicit Design References**: Each shot explicitly declares which character and environment designs it uses, enabling precise asset filtering.
4. **Separation of Visual and Narrative**: The `audio_and_narrative` field is excluded from image prompts to prevent accidental text overlay in generated images.

## New Storyboard Entry Structure

The shot director will now produce `storyboard_entry` objects with this enhanced schema:

```typescript
interface StoryboardEntry {
  // Existing fields (unchanged)
  framing_and_angle: string;
  composition_and_content: string;
  character_action_and_emotion: string;
  camera_dynamics: string;
  lighting_and_atmosphere: string;
  continuity_notes: string;

  // NEW: Explicit design references
  referenced_designs: {
    characters: string[];      // Array of character_id values
    environments: string[];    // Array of environment_id values
  };

  // CHANGED: Structured audio/narrative instead of flat dialogue
  audio_and_narrative: Array<{
    type: "monologue" | "dialogue";
    source: string;    // "narrator" for monologue, character_id for dialogue
    line: string;      // Text with performance notes in parentheticals
  }>;
}
```

### Migration from Legacy Structure
- **Old `dialogue` field** (array of `{character, line}`) → **New `audio_and_narrative`** field (array with type discrimination)
- **Implicit character presence** → **Explicit `referenced_designs.characters`** array
- **No environment tracking** → **Explicit `referenced_designs.environments`** array

## Key Frame Image Prompt Assembly

The new assembly algorithm constructs prompts by combining filtered design documents with storyboard metadata:

### Assembly Algorithm

```typescript
function assembleKeyFramePrompt(
  shot: ShotRecord,
  visualDesignDocument: VisualDesignDocument
): object {
  const storyboard = shot.storyboardPayload as StoryboardEntry;
  const { referenced_designs } = storyboard;

  // Step 1: Extract global aesthetic (always included)
  const global_aesthetic = {
    visual_style: visualDesignDocument.visual_style,
    master_color_palette: visualDesignDocument.master_color_palette
  };

  // Step 2: Filter character designs (only referenced ones)
  const character_designs = visualDesignDocument.character_designs.filter(
    char => referenced_designs.characters.includes(char.character_id)
  );

  // Step 3: Filter environment designs (only referenced ones)
  const environment_designs = visualDesignDocument.environment_designs.filter(
    env => referenced_designs.environments.includes(env.environment_id)
  );

  // Step 4: Copy storyboard excluding audio_and_narrative
  const { audio_and_narrative, ...visualInstructions } = storyboard;

  // Step 5: Assemble final prompt structure
  return {
    global_aesthetic,
    character_designs,
    environment_designs,
    ...visualInstructions
  };
}
```

### Prompt Structure Example

The assembled prompt sent to Gemini image generation will be a JSON object with two sections:

```json
{
  "// Context for the image generation": {
    "global_aesthetic": {
      "visual_style": { "name": "...", "description": "..." },
      "master_color_palette": [...]
    },
    "character_designs": [...],
    "environment_designs": [...]
  },
  "// Image generation instruction": {
    "referenced_designs": {...},
    "framing_and_angle": "...",
    "composition_and_content": "...",
    "character_action_and_emotion": "...",
    "camera_dynamics": "...",
    "lighting_and_atmosphere": "...",
    "continuity_notes": "..."
  }
}
```

Note: The comment keys in the example are for documentation clarity; the actual implementation will use proper object nesting without comment keys.

## Database Schema Changes

### Shots Table Migration

**Drop columns** (deprecated fields):
- `first_frame_prompt TEXT NOT NULL`
- `key_frame_prompt TEXT NOT NULL`
- `video_clip_prompt TEXT NOT NULL`
- `first_frame_image_path TEXT` — first frame image generation is being deprecated

**Keep columns**:
- `storyboard_payload JSONB NOT NULL` — now contains the enhanced structure with `referenced_designs` and `audio_and_narrative`
- `key_frame_image_path TEXT` — only key frame images will be generated going forward

The `storyboard_payload` JSONB column will store the complete storyboard entry including the new fields. No schema enforcement at the database level; validation happens in application code.

### Migration Strategy
1. Create a new migration file to `ALTER TABLE shots DROP COLUMN` for the three prompt fields and `first_frame_image_path`.
2. Existing rows will lose prompt data and first frame image paths but retain `storyboard_payload` and `key_frame_image_path`.
3. Future shot production runs will populate `storyboard_payload` with the new structure.
4. **Breaking change**: Existing shots cannot use the new image generation path without regeneration.
5. First frame image generation is fully deprecated; only key frame images will be generated.

## Code Changes Overview

### Shot Production Changes

**IMPORTANT**: `system_prompts/create_shot_production.md` has already been updated with the new output format. Do not modify this file during implementation.

**Files to modify:**
- `agent-backend/src/shot-production/parseGeminiResponse.ts` — Parse `audio_and_narrative` and `referenced_designs`
- `agent-backend/src/shot-production/types.ts` — Update TypeScript interfaces
- `agent-backend/test/shotProductionResponseValidator.test.ts` — Update test expectations
- `agent-backend/fixtures/gemini/shot-production/*.json` — Update fixtures to new format

**Validation changes:**
- Validate `audio_and_narrative` array structure (type, source, line fields)
- Validate `referenced_designs` contains string arrays
- For dialogue entries, verify `source` matches a valid `character_id` from visual design
- For monologue entries, verify `source === "narrator"`

**Deprecations:**
- Remove code generating `first_frame_prompt`, `key_frame_prompt`, `video_clip_prompt`
- Remove prompt assembly logic in `agent-backend/src/shot-production/promptBuilder.ts` (keep only the user prompt assembly for Gemini, not the downstream generation prompts)

### Shot Image Generation Changes

**New file:**
- `agent-backend/src/shot-image/keyFramePromptAssembler.ts` — Implements the assembly algorithm

**Files to modify:**
- `agent-backend/src/shot-image/shotImageTask.ts` — Replace prompt string usage with assembled object, remove first frame image generation logic
- `supabase/src/shotsRepository.ts` — Remove prompt field mappings and `firstFrameImagePath` (keep only `storyboardPayload` and `keyFrameImagePath`)

**Image generation integration:**
- The assembled prompt object is serialized to JSON and sent as `userPrompt` to `geminiImageClient.generateImage()`
- Reference images are loaded based on `referenced_designs.characters` and `referenced_designs.environments` using existing reference image recommender logic
- The `create_shot_images.md` system prompt remains unchanged

### Video Generation (Out of Scope)
- Video clip prompt assembly is explicitly out of scope for this change.
- Video generation continues to use existing approaches until a future change addresses it.
- The `audio_and_narrative` field provides the foundation for future video+audio work.

## Backward Compatibility

**Breaking changes:**
- Existing shots in the database with populated prompt columns will not work with the new image generation path.
- First frame image generation is completely deprecated; `first_frame_image_path` column will be dropped.
- The `ShotRecord` TypeScript interface will no longer expose `firstFramePrompt`, `keyFramePrompt`, `videoClipPrompt`, or `firstFrameImagePath`.

**Migration path for existing stories:**
- Stories with shots already generated: Retain old data but cannot regenerate images without re-running shot production.
- Recommended: Treat this as a major version change and regenerate all shots for stories under active development.

## Testing Strategy

### Unit Tests
- Test prompt assembly algorithm with various design document structures
- Test filtering logic for referenced designs
- Test exclusion of `audio_and_narrative` from image prompts
- Test shot production parsing with new `storyboard_entry` format
- Test validation of `audio_and_narrative` type discrimination

### Integration Tests
- End-to-end test: Shot production → DB persistence → Image generation with assembled prompt
- Verify reference image loading uses `referenced_designs` correctly
- Verify generated images do not contain text overlays (validate `audio_and_narrative` exclusion)

### Fixture Updates
- Update all `agent-backend/fixtures/gemini/shot-production/*.json` files to include `referenced_designs` and `audio_and_narrative`
- Remove `generation_prompts` from fixtures

## Error Handling

### Shot Production Validation Errors
- Missing `referenced_designs` field → Fail validation with clear message
- Missing `audio_and_narrative` field → Fail validation
- Invalid `audio_and_narrative.type` (not "monologue" or "dialogue") → Fail validation
- Dialogue with `source !== character_id` from visual design → Fail validation
- Monologue with `source !== "narrator"` → Fail validation

### Image Generation Errors
- Referenced character/environment ID not found in visual design document → Fail with clear message listing missing IDs
- Empty `referenced_designs` arrays → Warning but allow (for shots with no characters/environments)

## Rollout Plan

### Phase 1: Database Migration
1. Create and apply migration to drop deprecated prompt columns
2. Update repository interfaces to remove prompt field mappings
3. Deploy schema changes to production

### Phase 2: Shot Production Updates
1. Update system prompt and parsing logic
2. Update validation and tests
3. Update fixtures
4. Deploy shot production changes

### Phase 3: Image Generation Updates
1. Implement prompt assembly algorithm
2. Update shot image task to use assembled prompts
3. Update tests and integration paths
4. Deploy image generation changes

### Validation Gates
- After each phase, run full test suite
- Manual validation: Generate shots for a test story and verify new structure
- Manual validation: Generate images using assembled prompts and verify fidelity

## Future Enhancements (Out of Scope)

- Video clip prompt assembly using similar structured approach
- Audio generation integration using `audio_and_narrative` for voice synthesis
- Dynamic prompt assembly based on generation model capabilities (different assemblers for different models)
- Shot regeneration tooling with selective field updates
